<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>~/Development/nibs/lib/snapshot.rb.html</title>
<meta name="Generator" content="Vim/7.1">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
</head>
<body bgcolor="#1a1a1a" text="#7e7e7e"><font face="monospace">
<font color="#1773cc">require</font>&nbsp;<font color="#8a2ae2">'</font><font color="#4a6f8b">fileutils</font><font color="#8a2ae2">'</font><br>
<font color="#1773cc">require</font>&nbsp;<font color="#8a2ae2">'</font><font color="#4a6f8b">pathname</font><font color="#8a2ae2">'</font><br>
<br>
<font color="#1773cc">class</font>&nbsp;<font color="#008b8b"><b>Snapshot</b></font>&nbsp;&lt; <font color="#008b8b"><b>Backup</b></font><br>
&nbsp;&nbsp;<font color="#9a2fff"><b>attr_reader</b></font>&nbsp;<font color="#ffc125">:src</font>, <font color="#ffc125">:dest</font>, <font color="#ffc125">:schema</font>, <font color="#ffc125">:siblings</font>, <font color="#ffc125">:oldest_sib</font>, <font color="#ffc125">:excludes</font><br>
&nbsp;&nbsp;<br>
&nbsp;&nbsp;<font color="#79c4cc"><i># Initialize with only one schema, control taking snapshots of *each* schema in the settings file</i></font><br>
&nbsp;&nbsp;<font color="#79c4cc"><i># from the command line script or the superclass.</i></font><br>
&nbsp;&nbsp;<font color="#1773cc">def</font>&nbsp;<font color="#458b73">initialize</font>(schema)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#458b73">@schema</font>&nbsp;&nbsp;&nbsp;&nbsp; = <font color="#008b8b"><b>Backup</b></font>::<font color="#008b8b"><b>SETTINGS</b></font>[schema]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#458b73">@src</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= <font color="#008b8b"><b>Pathname</b></font>.new(<font color="#458b73">@schema</font>[<font color="#8a2ae2">'</font><font color="#4a6f8b">source</font><font color="#8a2ae2">'</font>])<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#458b73">@dest</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = <font color="#008b8b"><b>Pathname</b></font>.new(<font color="#458b73">@schema</font>[<font color="#8a2ae2">'</font><font color="#4a6f8b">snapshot directory</font><font color="#8a2ae2">'</font>])<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#458b73">@max_snaps</font>&nbsp;&nbsp;= <font color="#458b73">@schema</font>[<font color="#8a2ae2">'</font><font color="#4a6f8b">snapshots</font><font color="#8a2ae2">'</font>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#458b73">@excludes</font>&nbsp;&nbsp; = <font color="#458b73">@schema</font>[<font color="#8a2ae2">'</font><font color="#4a6f8b">exclude</font><font color="#8a2ae2">'</font>].map {|<font color="#458b73">e</font>|&nbsp;<font color="#8a2ae2">&quot;</font><font color="#4a6f8b">--exclude=</font><font color="#8a2ae2">#{</font>e<font color="#8a2ae2">}</font><font color="#4a6f8b">&nbsp;</font><font color="#8a2ae2">&quot;</font>&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#458b73">@siblings</font>&nbsp;&nbsp; = <font color="#458b73">@dest</font>.children.reverse<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#458b73">@oldest_sib</font>&nbsp;= <font color="#458b73">@siblings</font>[<font color="#ffc125">0</font>].to_s<br>
&nbsp;&nbsp;<font color="#1773cc">end</font><br>
<br>
&nbsp;&nbsp;<font color="#1773cc">def</font>&nbsp;<font color="#458b73">snap</font>(delete=<font color="#8b094f">true</font>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;age_siblings <font color="#9a2fff"><b>unless</b></font>&nbsp;<font color="#458b73">@siblings</font>.empty?<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#9a2fff"><b>if</b></font>&nbsp;delete<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ffc125">self</font>.synchronize_snap_zero<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#9a2fff"><b>else</b></font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ffc125">self</font>.synchronize_snap_zero_no_delete<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#9a2fff"><b>end</b></font><br>
&nbsp;&nbsp;<font color="#1773cc">end</font><br>
<br>
&nbsp;&nbsp;<font color="#1773cc">def</font>&nbsp;<font color="#458b73">age_siblings</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#458b73">@siblings</font>.each <font color="#9a2fff"><b>do</b></font>&nbsp;|<font color="#458b73">sib</font>|<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d = sib.to_s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rev = d.slice(<font color="#8a2ae2">/</font><font color="#4a6f8b">\d+</font><font color="#8a2ae2">/</font>).to_i<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#9a2fff"><b>if</b></font>&nbsp;rev &gt;= <font color="#458b73">@max_snaps</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#79c4cc"><i># Delete snapshots past max number to keep...</i></font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008b8b"><b>LOG</b></font>.info(<font color="#8a2ae2">&quot;</font><font color="#4a6f8b">Deleting old snapshots...</font><font color="#8a2ae2">&quot;</font>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008b8b"><b>Pathname</b></font>.rmtree(d)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008b8b"><b>LOG</b></font>.info(<font color="#8a2ae2">&quot;</font><font color="#4a6f8b">..done</font><font color="#8a2ae2">&quot;</font>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#9a2fff"><b>elsif</b></font>&nbsp;rev &gt; <font color="#ffc125">0</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#79c4cc"><i># Rename the snapshots from 1 to Max, increasing by 1</i></font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oldname = d<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newname = <font color="#458b73">@dest</font>.to_s + <font color="#8a2ae2">&quot;</font><font color="#4a6f8b">/Snapshot.</font><font color="#8a2ae2">&quot;</font>&nbsp;+ (rev + <font color="#ffc125">1</font>).to_s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008b8b"><b>FileUtils</b></font>.mv(oldname, newname)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008b8b"><b>LOG</b></font>.info(<font color="#8a2ae2">&quot;</font><font color="#4a6f8b">Aging </font><font color="#8a2ae2">#{</font>oldname<font color="#8a2ae2">}</font><font color="#4a6f8b">...</font><font color="#8a2ae2">&quot;</font>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#9a2fff"><b>else</b></font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#79c4cc"><i># Treat Snapshot 0 differently, creating a hardlink-only copy of itself to Snapshot.1&nbsp;&nbsp; </i></font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8a2ae2">`</font><font color="#4a6f8b">cd </font><font color="#8a2ae2">#{</font>(<font color="#458b73">@dest</font>&nbsp;+ <font color="#8a2ae2">&quot;</font><font color="#4a6f8b">Snapshot.0</font><font color="#8a2ae2">&quot;</font>).to_s<font color="#8a2ae2">}</font><font color="#4a6f8b">&nbsp;&amp;&amp; find . -print | cpio -dplm </font><font color="#8a2ae2">#{</font>(<font color="#458b73">@dest</font>&nbsp;+ <font color="#8a2ae2">&quot;</font><font color="#4a6f8b">Snapshot.1</font><font color="#8a2ae2">&quot;</font>).to_s<font color="#8a2ae2">}</font><font color="#4a6f8b">&nbsp;;</font><font color="#8a2ae2">`</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008b8b"><b>LOG</b></font>.info(<font color="#8a2ae2">&quot;</font><font color="#4a6f8b">Created a hard-link copy of Snapshot.0</font><font color="#8a2ae2">&quot;</font>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#9a2fff"><b>end</b></font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#9a2fff"><b>end</b></font><br>
&nbsp;&nbsp;<font color="#1773cc">end</font><br>
&nbsp;&nbsp;<br>
&nbsp;&nbsp;<font color="#79c4cc"><i># </i></font><span style="background-color: #00beff"><font color="#008b00">TODO</font></span><font color="#79c4cc"><i>: To make sure it lists all of the patterns to exclude correctly, use Array#map instead of just puts!</i></font><br>
&nbsp;&nbsp;<font color="#1773cc">def</font>&nbsp;<font color="#458b73">synchronize_snap_zero</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008b8b"><b>LOG</b></font>.info(<font color="#8a2ae2">&quot;</font><font color="#4a6f8b">Synchronizing </font><font color="#8a2ae2">#{</font><font color="#458b73">@src</font>.to_s<font color="#8a2ae2">}</font><font color="#4a6f8b">&nbsp;with </font><font color="#8a2ae2">#{</font>(<font color="#458b73">@dest</font>&nbsp;+ <font color="#8a2ae2">&quot;</font><font color="#4a6f8b">Snapshot.0</font><font color="#8a2ae2">&quot;</font>).to_s<font color="#8a2ae2">}</font><font color="#8a2ae2">&quot;</font>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8a2ae2">`</font><font color="#4a6f8b">rsync -avzrE --delete </font><font color="#8a2ae2">#{</font><font color="#458b73">@excludes</font>.to_s<font color="#8a2ae2">}#{</font><font color="#458b73">@src</font>.to_s<font color="#8a2ae2">}</font><font color="#4a6f8b">/ </font><font color="#8a2ae2">#{</font>(<font color="#458b73">@dest</font>&nbsp;+ <font color="#8a2ae2">&quot;</font><font color="#4a6f8b">Snapshot.0</font><font color="#8a2ae2">&quot;</font>).to_s<font color="#8a2ae2">}</font><font color="#4a6f8b">/</font><font color="#8a2ae2">`</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008b8b"><b>LOG</b></font>.info(<font color="#8a2ae2">&quot;</font><font color="#4a6f8b">...done</font><font color="#8a2ae2">&quot;</font>)<br>
&nbsp;&nbsp;<font color="#1773cc">end</font><br>
&nbsp;&nbsp;<br>
&nbsp;&nbsp;<font color="#1773cc">def</font>&nbsp;<font color="#458b73">synchronize_snap_zero_no_delete</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008b8b"><b>LOG</b></font>.info(<font color="#8a2ae2">&quot;</font><font color="#4a6f8b">Synchronizing </font><font color="#8a2ae2">#{</font><font color="#458b73">@src</font>.to_s<font color="#8a2ae2">}</font><font color="#4a6f8b">&nbsp;with </font><font color="#8a2ae2">#{</font>(<font color="#458b73">@dest</font>&nbsp;+ <font color="#8a2ae2">&quot;</font><font color="#4a6f8b">Snapshot.0</font><font color="#8a2ae2">&quot;</font>).to_s<font color="#8a2ae2">}</font><font color="#8a2ae2">&quot;</font>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8a2ae2">`</font><font color="#4a6f8b">rsync -avzrE </font><font color="#8a2ae2">#{</font><font color="#458b73">@excludes</font>.to_s<font color="#8a2ae2">}#{</font><font color="#458b73">@src</font>.to_s<font color="#8a2ae2">}</font><font color="#4a6f8b">/ </font><font color="#8a2ae2">#{</font>(<font color="#458b73">@dest</font>&nbsp;+ <font color="#8a2ae2">&quot;</font><font color="#4a6f8b">Snapshot.0</font><font color="#8a2ae2">&quot;</font>).to_s<font color="#8a2ae2">}</font><font color="#4a6f8b">/</font><font color="#8a2ae2">`</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008b8b"><b>LOG</b></font>.info(<font color="#8a2ae2">&quot;</font><font color="#4a6f8b">...done</font><font color="#8a2ae2">&quot;</font>)<br>
&nbsp;&nbsp;<font color="#1773cc">end</font><br>
&nbsp;&nbsp;<br>
<font color="#1773cc">end</font><br>
</font></body>
</html>
